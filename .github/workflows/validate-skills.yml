name: Validate Skills

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  discover-skills:
    runs-on: ubuntu-latest
    outputs:
      skills: ${{ steps.collect.outputs.skills }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Collect skill directories
        id: collect
        shell: bash
        run: |
          python3 - <<'PY' >> "$GITHUB_OUTPUT"
          import json
          from pathlib import Path

          root = Path("skills")
          skills = []

          if root.exists():
              for directory in sorted(root.iterdir()):
                  if directory.is_dir() and (directory / "SKILL.md").exists():
                      skills.append({"path": str(directory)})

          print(f"skills={json.dumps(skills)}")
          PY

  validate-skills:
    needs: discover-skills
    if: ${{ needs.discover-skills.outputs.skills != '[]' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        skill: ${{ fromJSON(needs.discover-skills.outputs.skills) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Validate skill
        run: |
          echo "Validating ${{ matrix.skill.path }}"
          npx --yes skills-ref validate "${{ matrix.skill.path }}"

  no-skills:
    needs: discover-skills
    if: ${{ needs.discover-skills.outputs.skills == '[]' }}
    runs-on: ubuntu-latest
    steps:
      - name: Report empty skills directory
        run: echo "No skill directories with SKILL.md found under skills/."
